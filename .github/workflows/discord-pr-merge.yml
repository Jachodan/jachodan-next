name: Notify Discord on PR Merge to Main

on:
  pull_request:
    types: [closed]

jobs:
  notify-on-merge:
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Info
        run: |
          title=$(jq -r ".pull_request.title" "$GITHUB_EVENT_PATH")
          url=$(jq -r ".pull_request.html_url" "$GITHUB_EVENT_PATH")
          actor=$(jq -r ".pull_request.user.login" "$GITHUB_EVENT_PATH")
          changed_files=$(jq -r ".pull_request.changed_files" "$GITHUB_EVENT_PATH")

          echo "title=$title" >> $GITHUB_ENV
          echo "url=$url" >> $GITHUB_ENV
          echo "actor=$actor" >> $GITHUB_ENV
          echo "changed_files=$changed_files" >> $GITHUB_ENV

      - name: Notify Discord on Merge
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail

          if [[ "${{ env.changed_files }}" -eq 0 ]]; then
            change_msg="âš ï¸ ë³€ê²½ëœ ì½”ë“œ ì—†ìŒ"
          else
            change_msg="ğŸ”§ ë³€ê²½ íŒŒì¼ ìˆ˜: ${{ env.changed_files }}"
          fi

          payload=$(jq -n \
            --arg title "${{ env.title }}" \
            --arg url "${{ env.url }}" \
            --arg actor "${{ env.actor }}" \
            --arg change "$change_msg" \
            '{
              "embeds": [
                {
                  "title": "âœ… main ë¸Œëœì¹˜ì— PR ë¨¸ì§€ ì™„ë£Œ!",
                  "description": "**ì‘ì„±ì-** \($actor)\n**PR Message-** \($title)\nğŸ”— [PR ë³´ëŸ¬ê°€ê¸°](\($url))\n\n\($change)",
                  "color": 3066993,
                  "timestamp": now | todateiso8601
                }
              ]
            }')

          curl -H "Content-Type: application/json" \
              -X POST \
              -d "$payload" \
              "$DISCORD_WEBHOOK"
